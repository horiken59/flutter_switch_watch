# requirements.md

本ドキュメントは、本アプリにおける **用語定義 / ユースケース / 受入条件 / 非機能要件** を定義する。
実装・設計・テストは本書を一次仕様（Single Source of Truth）とする。

---

## 1. 用語定義

| 用語 | 説明 |
|---|---|
| Work | ユーザーが管理する作業単位（例：料理、勉強） |
| Task | Workに属する作業工程（例：切る、煮る） |
| TaskDef | Workに紐づくTaskの定義情報 |
| Session | 1回の記録結果（Finish時に確定保存される） |
| SessionTaskTotal | Session内でのTaskごとの累積時間 |
| Record | 記録画面における計測状態全体 |
| Idle | 記録未開始状態 |
| Running | いずれかのTaskが計測中の状態 |
| Paused | 記録は開始済みだが、現在計測中のTaskがない状態 |
| activeTask | 現在計測中のTask |
| accumulatedMs | 確定済みの累積時間（ms） |
| totalMs | Session全体の合計時間（Task累積の総和） |
| Snapshot | 記録時点のWork名・Task名を保持する仕組み |

---

## 2. ユースケース

### UC-01 Workを作成する
- ユーザーはWork名を入力する
- ユーザーは1件以上のTaskを入力する
- Taskは入力順でorderが付与される
- 作成後、Work一覧に表示される

### UC-02 Workの詳細を確認する
- ユーザーはWork一覧からWorkを選択できる
- Work名とTask一覧を確認できる

### UC-03 記録を開始・切替・一時停止する
- タスク行をタップすると記録が開始される
- 実行中のタスクをタップすると一時停止になる
- 別のタスクをタップすると計測が切り替わる
- 一時停止中にタスクをタップすると再開される

### UC-04 記録を完了（Finish）する
- ユーザーはFinishボタンを押下できる
- 記録内容がSessionとして保存される
- Result画面に遷移する

### UC-05 記録を破棄して戻る
- 記録を一度でも開始していた場合、戻る操作で確認ダイアログが表示される
- 破棄を選択すると記録状態は破棄され、DBには保存されない

### UC-06 履歴を閲覧する
- Sessionの一覧を新しい順で閲覧できる
- Sessionの詳細を確認できる
- Result画面から履歴詳細・履歴一覧へ遷移できる

---

## 3. 受入条件（Acceptance Criteria）

### AC-01 Work作成
- [ ] Work名が未入力の場合、作成できない
- [ ] Taskが0件の場合、作成できない
- [ ] 同一Work内でTask名の重複は不可（前後空白を除去して比較）
- [ ] Taskのorderは入力順（0から連番）

### AC-02 記録ロジック
- [ ] 初回タスクタップで記録が開始される
- [ ] 実行中タスクの再タップでPausedになる
- [ ] 実行中に別タスクをタップすると切替される
- [ ] Paused中にタスクをタップすると再開される
- [ ] Paused中は時間が加算されない

### AC-03 時間計算
- [ ] 各Taskの表示時間は累積＋進行中分で表示される
- [ ] totalMsは各Taskの累積時間の総和と一致する
- [ ] Finish時、Running中の区間は必ず確定加算される

### AC-04 Finish処理
- [ ] Finish時のみSessionがDBに保存される
- [ ] 記録中はDBへ逐次書き込みしない
- [ ] SessionにはWork名・Task名のスナップショットが保存される

### AC-05 戻る操作
- [ ] 記録未開始なら即戻れる
- [ ] 記録開始後は確認ダイアログが表示される
- [ ] 破棄を選択した場合、Sessionは保存されない

### AC-06 履歴表示
- [ ] Session一覧は startedAt の降順で表示される
- [ ] 履歴表示はSnapshot名を使用する
- [ ] 合計時間は hh:mm:ss 形式で表示される

---

## 4. 非機能要件

### 4.1 技術制約
- フレームワーク: Flutter
- DB: Realm（ローカルのみ、同期なし）
- 状態管理: flutter_riverpod
- ルーティング: go_router
- ID: Realm ObjectId
- 時間表示形式: hh:mm:ss

### 4.2 パフォーマンス
- UI更新頻度は1秒ごとで良い
- 内部時間管理はミリ秒単位で保持する
- 記録中は不要なDBアクセスを行わない

### 4.3 信頼性・整合性
- totalMsとtaskTotalsの不整合は禁止
- Sessionは必ずFinish操作を経て保存される
- 記録中の状態はアプリ再起動で保持しない（MVP仕様）

### 4.4 保守性・拡張性
- 記録ロジックはUIから独立したControllerとして実装される
- Snapshot方式により、将来の名称変更に耐える構造とする

---

## 5. 本書の位置づけ

- 本書は **設計・実装・テストの基準** とする
- 実装は本書の受入条件を満たすこと
- 本書に記載のない挙動は未定義仕様とする
